{{- $spineprefix := .Config.Vars.Spineprefix }}
{{- $loopbackip := .Config.Vars.Loopbackip }}
{{- $rrasn := .Config.Vars.RRASN }}

routing-policy {
    prefix-set leaf-loopback {
        prefix 10.0.0.0/21 mask-length-range 32..32 {
        }
    }
    prefix-set loopback {
        prefix {{ $loopbackip }}/32 mask-length-range 32..32 {
        }
    }
    policy export-loopback {
        default-action {
            policy-result reject
        }
        statement accept-loopback {
            match {
                prefix {
                    prefix-set loopback
                }
            }
            action {
                policy-result accept
            }
        }
    }
    policy export-none {
        default-action {
            policy-result reject
        }
    }
    policy import-evpn {
        default-action {
            policy-result reject
        }
        statement accept-evpn {
            match {
                family [
                    evpn
                ]
            }
            action {
                policy-result accept
            }
        }
    }
    policy import-loopbacks {
        default-action {
            policy-result reject
        }
        statement accept-loopbacks {
            match {
                prefix {
                    prefix-set leaf-loopback
                }
            }
            action {
                policy-result accept
            }
        }
    }
}
network-instance default {
    type default
    admin-state enable
    router-id {{ $loopbackip }}

{{- $intfs := index .Config.Vars "vlans" }}
{{- if $intfs }}
{{- range $intf, $vlans := $intfs }}
{{- if $vlans }}
{{- range $vlan := $vlans }}
    interface {{ $intf }}.{{ $vlan }} {
    }
{{- end }}
{{- end }}
{{- end }}
{{- end }}

    interface system0.0 {
    }
    protocols {
        bgp {
            autonomous-system {{ $rrasn }}
            router-id {{ $loopbackip }}
            dynamic-neighbors {
                accept {
                    match 10.0.0.0/21 {
                        peer-group overlay
                        allowed-peer-as [
                            65500
                        ]
                    }
                    match 10.{{ $spineprefix }}.0.0/21 {
                        peer-group underlay
                        allowed-peer-as [
                            82000..83000
                        ]
                    }
                }
            }
            afi-safi evpn {
                evpn {
                    inter-as-vpn true
                }
            }
            afi-safi ipv4-unicast {
                admin-state enable
            }
            group overlay {
                peer-as 65500
                export-policy [
                    export-none
                ]
                import-policy [
                    import-evpn
                ]
                afi-safi evpn {
                    admin-state enable
                }
                afi-safi ipv4-unicast {
                    admin-state disable
                }
                local-as {
                    as-number 65500
                }
                transport {
                    local-address {{ $loopbackip }}
                }
            }
            group underlay {
                export-policy [
                    export-loopback
                ]
                import-policy [
                    import-loopbacks
                ]
                afi-safi evpn {
                    admin-state disable
                }
                afi-safi ipv4-unicast {
                    admin-state enable
                }
            }
        }
    }
}

interface system0 {
    subinterface 0 {
        admin-state enable
        ipv4 {
            admin-state enable
            address {{ $loopbackip }}/32 {
            }
        }
    }
}

{{- $intfs := index .Config.Vars "vlans" }}
{{- if $intfs }}
{{- range $intf, $vlans := $intfs }}
interface {{ $intf }} {
    admin-state enable
    vlan-tagging true
{{- if $vlans }}
{{- range $vlan := $vlans }}
{{- $ipindex := subtract $vlan 1}}
{{- $ipaddr := mul $ipindex 2 }}
    subinterface {{ $vlan }} {
        admin-state enable
        ipv4 {
            admin-state enable
            address 10.{{ $spineprefix }}.{{ idiv $ipaddr 256 }}.{{ rem $ipaddr 256 }}/31 {
            }
        }
        vlan {
            encap {
                single-tagged {
                    vlan-id {{ $vlan }}
                }
            }
        }
    }
{{- end }}
{{- end }}
}
{{- end }}
{{- end }}